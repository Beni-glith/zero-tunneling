name: 🔒 Auto Obfuscate & Replace

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

jobs:
  obfuscate-and-replace:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Izin untuk overwrite file

    steps:
    # 1. Checkout repo (full history)
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. Obfuscate dan replace file
    - name: Process Scripts
      run: |
        # Buat backup original (opsional)
        mkdir -p original_backups
        cp *.sh original_backups/ || echo "No files to backup"

        # Obfuscate dan overwrite di root
        for file in *.sh; do
          echo "🔐 Processing $file..."
          
          # Buat file obfuscated sementara
          {
            echo '#!/bin/bash'
            echo "# 🔒 OBFUSCATED - JANGAN EDIT LANGSUNG"
            echo 'eval "$(base64 -d <<<"'
            base64 $file
            echo '")"'
          } > temp_obfuscated

          # Replace file original
          mv temp_obfuscated $file
          chmod +x $file
          echo "✅ $file has been obfuscated in-place"
        done

        # Verifikasi
        echo "📂 Current files:"
        ls -la *.sh

    # 3. Push perubahan ke root
    - name: Commit Changes
      run: |
        git config --global user.name "GitHub Obfuscator"
        git config --global user.email "actions@github.com"
        
        git add *.sh
        git add original_backups/
        git commit -m "🔒 Scripts obfuscated in-place [$(date +'%Y-%m-%d %H:%M')]"
        git push
