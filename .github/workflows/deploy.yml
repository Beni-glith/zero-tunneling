name: Build Selfâ€‘Extracting Installer

on:
  push:
    paths:
      - build.sh

jobs:
  build-installer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y bzip2

      - name: Compress build.sh
        run: |
          chmod +x build.sh
          bzip2 -kf build.sh  # -> build.sh.bz2

      - name: Create installer.sh
        run: |
          # Hitung jumlah baris header
          HEADER_LINES=22

          cat <<EOF > installer.sh
#!/bin/sh
skip=$HEADER_LINES
set -C
orig_umask=\$(umask)
umask 77
tmpfile=\$(mktemp /tmp/zero-tunneling.XXXXXX) || exit 1
  if ln -T "$tmpfile" "/tmp/$prog" 2>/dev/null; then
    trap 'rm -f "$tmpfile" "/tmp/$prog"; exit $res' 0
    (sleep 5; rm -f "$tmpfile" "/tmp/$prog") 2>/dev/null &
    /bin/sh "/tmp/$prog" "$@"; res=$?
  else
    trap 'rm -f "$tmpfile"; exit $res' 0
    (sleep 5; rm -f "$tmpfile") 2>/dev/null &
    /bin/sh "$tmpfile" "$@"; res=$?
  fi

else
  echo "Cannot decompress \$0"; exit 1
fi
exit \$res
EOF

          cat build.sh.bz2 >> installer.sh
          chmod +x installer.sh

      - name: Upload installer.sh
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: installer.sh
